---
- hosts: localhost
  connection: local
  become: true

  tasks:

# ################################
# ubuntu-desktop
# ################################
  - name: 'apt packages: install ubuntu-desktop'
    package:
      name: ubuntu-desktop

# ################################
# users
# ################################
  - name: 'users: creating "etienneg"'
    user:
      state: present
      name: "{{ item }}"
      shell: /bin/bash
      append: yes
      groups: adm,cdrom,sudo,dip,plugdev,lpadmin,lxd
      password: '$6$bc.dsTpAG4tmqRK6$o8dO2F8vjgOTWvykliZst04Iwp./Dl1MLHxfrFEJ0XVQCnwP2kUFGb.33ADvq5Y0gq0WXYANOQZuer22NXxx90'
      update_password: on_create
    loop:
      - etienneg
    # register: users_forced_to_change_password
    # notify: change password

  - name: 'users: creating "ansible-deploy"'
    user:
      state: present
      name: ansible-deploy
      system: yes
      shell: /bin/false

# ################################
# apt packages
# ################################
  - name: 'apt packages: install CLI development tools'
    package:
      name:
        - jq
        - tree
        - shellcheck
        - libsecret-tools
        - python3-pip

# ################################
# snap packages
# ################################
  - name: 'snap packages: install GUI development tools'
    snap:
      name:
        - code
        - notepadqq
        - VirtualBox
        # - docker
        # - rabbitvcs

  - name: 'snap packages: install desktop tools'
    snap:
      name:
        - brave
        - blueman
        # - teams / teams-for-linux

# ################################
# system config
# ################################
  - name: 'system config: disabling Wayland and setting Xorg as default display server'
    copy:
      src: files/etc/gdm3/custom.conf
      dest: /etc/gdm3/custom.conf
      owner: root
      group: root
      mode: 0644
      backup: yes

  - name: 'system config: restarting gdm3 service'
    service:
      name: gdm3
      state: restarted

# ################################
# users config
# ################################
  - name: 'users config: adding user "ansible-deploy" to sudoers list'
    copy:
      src: files/etc/sudoers.d/ansible-deploy
      dest: /etc/sudoers.d/ansible-deploy
      owner: root
      group: root
      mode: 0440

  - name: 'users config: adding ansible-pull cron job for user "ansible-deploy"'
    cron:
      name: 'ansible auto-provision'
      user: ansible-deploy
      minute: '*/10'
      job: ansible-pull -o -U https://github.com/etiennegaschet/ansible_ubuntu-desktop-22.04.1-lts.git

# ################################
# handlers
# ################################
  handlers:
    - name: 'handlers: forcing new users to change their password on first login'
      shell: chage -d 0 {{ item.name }}
      loop: "{{ users_forced_to_change_password.results }}"
      when: item.changed
      listen: change password