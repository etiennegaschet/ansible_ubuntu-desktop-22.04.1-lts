---
- hosts: localhost
  connection: local
  become: true
  vars:
    list_users:
      - etienneg

  tasks:

# ################################
# locale-gen and localectl
# ################################

  - name: 'locale-gen: fr_FR (ISO-8859-1)'
    community.general.locale_gen:
      state: present
      name: fr_FR

  - name: 'locale-gen: fr_FR.UTF-8'
    community.general.locale_gen:
      state: present
      name: fr_FR.UTF-8

  - name: 'locale-gen: en_US (ISO-8859-1)'
    community.general.locale_gen:
      state: present
      name: en_US

  - name: 'locale-gen: en_US.UTF-8'
    community.general.locale_gen:
      state: present
      name: en_US.UTF-8

  - name: 'localectl: configure locale and language'
    ansible.builtin.command: localectl set-locale LANG=en_US.UTF-8 LANGUAGE=en_US

  - name: 'localectl: set-x11-keymap'
    ansible.builtin.command: localectl set-x11-keymap fr

# ################################
# apt-get update && apt-get upgrade
# ################################

  # - name: 'apt-get update'
  #   ansible.builtin.apt:
  #     force_apt_get: yes
  #     update_cache: yes

  # - name: 'apt-get upgrade'
  #   ansible.builtin.apt:
  #     force_apt_get: yes
  #     upgrade: yes

# ################################
# ubuntu-desktop
# ################################

  - name: 'apt packages: install ubuntu-desktop'
    ansible.builtin.apt:
      state: present
      force_apt_get: yes
      name: ubuntu-desktop

# ################################
# users
# ################################

  - name: 'users: creating users'
    ansible.builtin.user:
      state: present
      name: "{{ item }}"
      shell: /bin/bash
      home: "/home/{{ item }}"
      append: yes
      groups: adm,cdrom,sudo,dip,plugdev,lpadmin,lxd
      password: '$6$bc.dsTpAG4tmqRK6$o8dO2F8vjgOTWvykliZst04Iwp./Dl1MLHxfrFEJ0XVQCnwP2kUFGb.33ADvq5Y0gq0WXYANOQZuer22NXxx90'
      update_password: on_create
    loop: "{{ list_users }}"
    # register: users_forced_to_change_password
    # notify: change password

  - name: 'users: creating "ansible-deploy"'
    ansible.builtin.user:
      state: present
      name: ansible-deploy
      system: yes
      shell: /bin/false

# ################################
# apt packages
# ################################

  - name: 'apt packages: install CLI development tools'
    ansible.builtin.apt:
      state: present
      force_apt_get: yes
      name:
        - git
        - jq
        - tree
        - shellcheck
        - libsecret-tools
        - python3-pip

  - name: 'apt packages: install GUI development tools'
    ansible.builtin.apt:
      state: present
      force_apt_get: yes
      name:
        - virtualbox
        - rabbitvcs-nautilus

  - name: 'apt packages: install desktop tools'
    ansible.builtin.apt:
      state: present
      force_apt_get: yes
      name:
        - blueman

# ################################
# snap packages
# ################################

  - name: 'snap packages: install GUI development tools'
    community.general.snap:
      state: present
      name:
        - notepadqq

  - name: 'snap packages: install vscode with --classic option'
    community.general.snap:
      state: present
      name: code
      classic: true

  - name: 'snap packages: install desktop tools'
    community.general.snap:
      state: present
      name:
        - snap-store
        - brave
        - teams

# ################################
# pip packages
# ################################

  - name: 'pip packages: install CLI development tools'
    ansible.builtin.pip:
      state: present
      name:
        - powerline-shell

# ################################
# apt-get autoclean && apt-get autoremove && apt-get clean
# ################################

  # - name: 'apt-get autoclean: remove useless packages from the cache'
  #   ansible.builtin.apt:
  #     force_apt_get: yes
  #     autoclean: yes

  # - name: 'apt-get autoremove: remove dependencies that are no longer required'
  #   ansible.builtin.apt:
  #     force_apt_get: yes
  #     autoremove: yes

  # - name: 'apt-get clean'
  #   ansible.builtin.apt:
  #     force_apt_get: yes
  #     clean: yes

# ################################
# system config
# ################################

  - name: 'system config: disabling Wayland and setting Xorg as default display server'
    ansible.builtin.copy:
      src: files/etc/gdm3/custom.conf
      dest: /etc/gdm3/custom.conf
      owner: root
      group: root
      mode: 0644
      backup: yes

  - name: 'system config: restarting gdm3 service'
    ansible.builtin.service:
      state: restarted
      name: gdm3

# ################################
# users config
# ################################

  - name: 'users config: copying "~/.bash_logout"'
    ansible.builtin.copy:
      src: "files/home/user/.bash_logout"
      dest: "/home/{{ item }}/.bash_logout"
      owner: "{{ item }}"
      group: "{{ item }}"
      mode: 0644
    loop: "{{ list_users }}"

  - name: 'users config: copying "~/.bash_aliases"'
    ansible.builtin.copy:
      src: "files/home/user/.bash_aliases"
      dest: "/home/{{ item }}/.bash_aliases"
      owner: "{{ item }}"
      group: "{{ item }}"
      mode: 0644
    loop: "{{ list_users }}"

  - name: 'users config: copying "~/.bashrc"'
    ansible.builtin.copy:
      src: "files/home/user/.bashrc"
      dest: "/home/{{ item }}/.bashrc"
      owner: "{{ item }}"
      group: "{{ item }}"
      mode: 0644
    loop: "{{ list_users }}"

  - name: 'users config: copying "~/.profile"'
    ansible.builtin.copy:
      src: "files/home/user/.profile"
      dest: "/home/{{ item }}/.profile"
      owner: "{{ item }}"
      group: "{{ item }}"
      mode: 0644
    loop: "{{ list_users }}"

  - name: 'users config: creating "~/.fonts" directory'
    ansible.builtin.file:
      state: directory
      path: "/home/{{ item }}/.fonts"
      owner: "{{ item }}"
      group: "{{ item }}"
      mode: '0775'
    loop: "{{ list_users }}"

  - name: 'users config: unzipping "CodeNewRoman" font archive'
    ansible.builtin.unarchive:
      src: "fonts/CodeNewRoman.zip"
      dest: /home/{{ item }}/.fonts"
      owner: "{{ item }}"
      group: "{{ item }}"
      mode: '0644'
    loop: "{{ list_users }}"

  - name: 'users config: updating the font cache'
    ansible.builtin.command: fc-cache -fv

  - name: 'users config: copying "~/.config/monitors.xml" (setting screen resolution)'
    ansible.builtin.copy:
      # src: "files/home/user/.config/monitors.xml"
      src: "files/home/user/.config/monitors-vagrant.xml"
      dest: "/home/{{ item }}/.config/monitors.xml"
      owner: "{{ item }}"
      group: "{{ item }}"
      mode: 0664
    loop: "{{ list_users }}"

# ################################
# ansible auto-provision
# ################################

  - name: 'ansible auto-provision: adding user "ansible-deploy" to sudoers list'
    ansible.builtin.copy:
      src: files/etc/sudoers.d/ansible-deploy
      dest: /etc/sudoers.d/ansible-deploy
      owner: root
      group: root
      mode: 0440

  - name: 'ansible auto-provision: adding ansible-pull cron job for user "ansible-deploy"'
    ansible.builtin.cron:
      state: present
      name: 'ansible auto-provision'
      user: ansible-deploy
      minute: '*/10'
      job: ansible-pull -o -U https://github.com/etiennegaschet/ansible_ubuntu-desktop-22.04.1-lts.git

# ################################
# system reboot
# ################################

  - name: 'system reboot'
    ansible.builtin.reboot:
      reboot_timeout: 10

# ################################
# handlers
# ################################

  # handlers:
  #   - name: 'handlers: forcing new users to change their password on first login'
  #     shell: chage -d 0 {{ item.name }}
  #     loop: "{{ users_forced_to_change_password.results }}"
  #     when: item.changed
  #     listen: change password
