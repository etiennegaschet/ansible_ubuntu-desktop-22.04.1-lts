- name: '01 - Vérification des pdf de synthèses en erreur'
  sql:
  - query: |
      select * 
      from pdf_synthesis_job psj 
      where status like '%ERROR%';
  batch: 'php /intranet/gu_api/current/bin/console app:create-synthese-pdf --error'

- name: '02 - Vérifier les régularisations payées dans un état incorrect'
  sql:
  - query: |
      select c.formality_id, vr.id as "vr_id", c.id as "cart_id", c.total, rr.id "rr_id", c.payment_date, f.status "f_status", vr.status "vr_status" from cart c
      inner join formality f on f.id = c.formality_id 
      inner join validation_request vr on vr.formality_id = c.formality_id
      inner join regularization_request rr on vr.id = rr.validation_request_id
      inner join regularization_object ro on ro.regularization_request_id = rr.id
      where c.status = 'PAID' and c.formality_id not in (select formality_id from cart c1 where c1.status = 'TO_PAY')
      and rr.status = 'IN_PROGRESS' and vr.partner_id = 'G'
      and ro."type" = 'PAYMENT'
      and f.status in ('VALIDATION_PENDING', 'AMENDMENT_PAID')-- vérifier pour 'AMENDMENT_PENDING' car possible...
      --group by c.formality_id
      order by c.formality_id desc, c.id desc;
  batch: 'php /intranet/gu_api/current/bin/console app:update-regularization-requests'

- name: '03 - Vérification des acquittements en erreur'
  sql:
  - query: |
      select f.company_name , fa.formality_id, f.status as forma_status, vr.status as vr_status, vr.id as val_req_id, f.premier_numero_liasse_formalite , pc."name" as partner_center_name,
      concat(fa2.user_first_name, ' ', fa2.user_name) as valideur, 
      fa2.date as ack_date, fa2.status as ack_status,fa2.cause
      from
      (
          select fa.formality_id, max(fa.id) as id
          from formality_acknowledge fa 
          inner join (select distinct formality_id from formality_acknowledge fa where status <> 'SUCCESS') fa2 on fa2.formality_id = fa.formality_id 
          inner join (select formality_id, id from validation_request vr where new = false and partner_id = 'G') vr on vr.formality_id = fa.formality_id 
          group by fa.formality_id
          order by fa.formality_id desc
      ) fa
      inner join formality_acknowledge fa2 on fa2.id = fa.id
      inner join formality f on f.id = fa.formality_id
      inner join validation_request vr on vr.formality_id = fa.formality_id and vr.partner_id = 'G'
      inner join partner_center pc on pc.id = vr.partner_center_id 
      where fa2.status <> 'SUCCESS' 
      and vr.status not in ('REJECTED', 'VALIDATED_PARTNER')
      order by valideur, ack_status, cause;

  cases:

  - ack_status: 'ERROR_PJ'
    cause: "impossible de récupèrer la liste des pièces jointes de la formalité de N° XXXXX à cause de Problème serveur pour joindre l'API de inpi. Code erreur: 502 et message: Bad Gateway"
    error_code: '502'
    actions:
      - "01) verifier via postman qu'on peut recuperer la liste des PJ"
      - '02) Si la liste est recuperable, mettre la validation_request correspondante a new=true'

  - ack_status: 'ERROR_PJ'
    cause: "problème de récuperation de la piece joint pour le Endpoint : /api/validation_requests/XXXXX/formality/attachments - piece id YYYYYYY- message d'erreur : Problème serveur pour joindre l'API de inpi. Code erreur: 500 et message: Internal Server Error"
    error_code: '500'
    actions:
      - "01) verifier via postman qu'on peut recuperer la PJ"
      - '02) Si la PJ est recuperable, mettre la validation_request correspondante a new=true'

  - ack_status: 'ERROR_PJ'
    cause: "problème de récuperation de la piece joint pour le Endpoint : /api/validation_requests/XXXXX/formality/attachments - piece id YYYYYYY- message d'erreur : Problème serveur pour joindre l'API de inpi. Code erreur: 502 et message: Bad Gateway"
    error_code: '502'
    actions:
      - "01) verifier via postman qu'on peut recuperer la PJ"
      - '02) Si la PJ est recuperable, mettre la validation_request correspondante a new=true'

  - ack_status: 'ERROR_PJ'
    cause: |
      1)  (404) : Le fichier n'a pas été trouvé sur le serveur.
      Id attachment : 1241215 (PJ_99 - Document_de_Synthese_J00011379070_v2.pdf)
    error_code: '404'
    actions:
      - "Verifier dans la table attachments que le fichier est en status=ERROR"
      - "Verifier qu'il est absent du sftp"
      - "Trouver la ligne correspondante dans la table pdf_synthesis_job et la passer à status=TO_DO"
      - "Se connecter sur GU_PROD_BATCH en tant que intranet et lancer la commande de generation des pdfs de synthese"

  - ack_status: 'ERROR_PJ'
    cause: |
      ERREUR file[id=XXXXXXX ("nom_de_fichier.ext")] : statusCode=404 (Not Found) ({"code":"404","webservice_code":"FORMALITY_ATTACHMENT_FILE","error_id":"5005","message":"Le fichier n'a pas été trouvé sur le serveur."}) lors de la requ...
    error_code: '404'
    actions:
      - ""

- name: '04 - Vérification des commandes non créées'
  sql:
  - query: |
      -- Cart bloquée (reçu paiement....)
      select vr.partner_id, c.formality_id , c.id as cart_id, c.total, c.payment_date , c.created , c.payment_date
      from cart c
      inner join validation_request vr on vr.formality_id = c.formality_id and vr.partner_id <> 'D'
      where c.status = 'PAID' and c.mip_order_num is null
      and (
          (c.total = 0 and vr.partner_id = 'G') or
          (c.total > 0)
      )  and c.payment_type is not null
      union
      select vr.partner_id, c.formality_id , c.id as cart_id, c.total, c.payment_date , c.created , c.payment_date
      from cart c
      inner join validation_request vr on vr.formality_id = c.formality_id and vr.partner_id = 'D' and vr.status <> 'VALIDATED_PARTNER'
      where c.status = 'PAID' and c.mip_order_num is null
      and c.payment_type is not null;
  - query: |
      select * from check_payment_job cpj where status <> 'DONE';
  batch: 'php /intranet/gu_api/current/bin/console app:get-receipt <cart_id>'
